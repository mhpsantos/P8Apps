(function(){function v(a){function c(){l(0);delete b.gatt;delete b.ancs;NRF.getGattforCentralServer||NRF.disconnect();setTimeout(function(){NRF.wake()},500)}var d;b.gatt=a;l(1);b.gatt.device.on("gattserverdisconnected",function(f){d&&clearInterval(d);e&&clearInterval(e);c()});E.on("kill",function(){b.gatt.disconnect().then(function(){NRF.sleep()})});NRF.setSecurity({passkey:"123456",mitm:1,display:1});var e=setTimeout(function(){d&&clearInterval(d);b.gatt.disconnect().then(c)},1E4);b.gatt.startBonding().then(function(){d=
setInterval(function(){var f=b.gatt.getSecurityStatus();f.connected?f.connected&&f.encrypted&&(clearInterval(d),clearTimeout(e),l(2),z()):(clearInterval(d),clearTimeout(e))},1E3)})["catch"](function(f){Terminal.println("ERROR "+f)})}function z(){b.ancs={primary:null,notify:null,control:null,data:null};b.gatt.getPrimaryService("7905F431-B5CE-4E99-A40F-4B1E122D00D0").then(function(a){b.ancs.primary=a;return a.getCharacteristic("9FBF120D-6301-42D9-8C58-25E699A21DBD")}).then(function(a){b.ancs.notify=
a;return b.ancs.primary.getCharacteristic("69D1D8F3-45E1-49A8-9821-9BBDFDAAD9D9")}).then(function(a){b.ancs.control=a;return b.ancs.primary.getCharacteristic("22EAC6E9-24D6-4BB5-BE44-B36ACE7C7BFB")}).then(function(a){b.ancs.data=a;l(3);b.ancs.notify.on("characteristicvaluechanged",function(c){var d=c.target.value,e=d.getUint8(0);c=d.getUint8(2);d=d.getUint32(4,!0);1<e||(n&&clearTimeout(n),A.includes(c)&&(e=b.notqueue.length,1==c?(k&&(b.notqueue.push(b.current),k=!1),b.notqueue.push({cat:c,uid:d})):
16>e&&(b.notqueue[e]={cat:c,uid:d}),n=setTimeout(p,1E3)))});b.ancs.data.on("characteristicvaluechanged",function(c){b.store(c.target.value.buffer);(c=b.gotmsg())&&B(b.buf,c)});b.ancs.notify.startNotifications().then(function(){b.ancs.data.startNotifications().then(function(){l(4)})})})["catch"](function(a){Terminal.println("ERROR "+a)})}function C(a){a=a.split("\n");for(var c=0;c<a.length;c++){a[c]=a[c].trim();var d=a[c];if(18<d.length){for(var e=18;10<e&&!" \t-_".includes(d[e]);)e--;10==e&&(e=18);
a[c]=d.substr(0,e);a.splice(c+1,0,d.substr(e))}}return a.join("\n")}function w(a){h.unshift(a);3<h.length&&h.pop()}function D(){m=setTimeout(function(){SCREENACCESS.release();m=void 0;k=!1;p()},500)}function B(a,c){function d(F){var x=new Uint8Array(6),q=DataView(x.buffer);q.setUint8(0,2);q.setUint32(1,b.current.uid,!0);q.setUint8(5,F?0:1);b.ancs.control.writeValue(x).then(D)}b.msgTO&&clearTimeout(b.msgTO);for(var e="",f=8;f<8+c.tlen;++f)e+=String.fromCharCode(a[f]);f="";for(var r=11+c.tlen;r<11+
c.tlen+c.mlen;++r)f+=String.fromCharCode(a[r]);f=C(f);w({ttl:e,msg:f});E.showPrompt();m&&clearTimeout(m);P8.awake||P8.wake();SCREENACCESS.request();P8.buzz();1!=b.current.cat?E.showAlert(f,e).then(d.bind(null,!1)):E.showPrompt(f,{title:e,buttons:{Accept:!0,Cancel:!1}}).then(d)}function p(){if(0!=b.notqueue.length&&!k){k=!0;b.current=b.notqueue.pop();var a=DataView(b.com.buffer);6==b.current.cat?a.setUint8(8,2):a.setUint8(8,3);a.setUint32(1,b.current.uid,!0);b.inp=0;b.ancs.control.writeValue(b.com).then(function(){b.msgTO=
setTimeout(function(){k=!1;b.msgTO=void 0;p()},1E3)})}}function l(a){t=a;WIDGETS.ancs.draw()}var y=require("Storage").readJSON("widancs.json",1)||{settings:{enabled:!1,category:[1,2,4]}},u=y.settings.enabled,A=y.settings.category,b={gatt:null,ancs:null,current:{cat:0,uid:0},notqueue:[],msgTO:void 0,com:new Uint8Array([0,0,0,0,0,1,20,0,3,100,0]),buf:new Uint8Array(132),inp:0,store:function(a){var c=this.inp;132>=c+a.length&&(this.buf.set(a,c),this.inp+=a.length)},gotmsg:function(){var a=this.inp,c=
DataView(this.buf.buffer);if(8>a)return null;var d=c.getUint16(6,!0);if(a<d+8)return null;c=c.getUint16(9+d,!0);return a<c+d+11?null:{tlen:d,mlen:c}}};if(!NRF.getGattforCentralServer&&u&&"undefined"!=typeof SCREENACCESS)NRF.on("disconnect",function(a){NRF.sleep()});if(u&&"undefined"!=typeof SCREENACCESS)NRF.on("connect",function(a){NRF.getGattforCentralServer?v(NRF.getGattforCentralServer(a)):NRF.connect(a).then(v)});var m,k=!1,h=[],n,t=5;WIDGETS.ancs={area:"tl",width:24,draw:function(){var a=new Uint16Array([50712,
63512,1023,65504,2016,0]),c=E.toArrayBuffer(atob("GBgBAAAABAAADgAAHwAAPwAAf4AAP4AAP4AAP4AAHwAAH4AAD8AAB+AAA/AAAfgAAf3gAH/4AD/8AB/+AA/8AAf4AAHwAAAgAAAA"));g.setColor(a[t]);g.drawImage(c,this.x,this.y)}};u&&"undefined"!=typeof SCREENACCESS&&(recent=t=0,NRF.setServices(void 0,{uart:!1}),NRF.sleep(),NRF.wake(),NRF.setAdvertising([2,1,6,17,21,208,0,45,18,30,75,15,164,153,78,206,181,49,244,5,121],{connectable:!0,discoverable:!0,interval:375}),w({ttl:"",msg:"NONE"}),TC.on("swipe",function(a){SCREENACCESS.withApp||
a!=TC.UP?SCREENACCESS.withApp&&a==TC.DOWN?(SCREENACCESS.request(),recent=0,E.showMessage(h[recent].msg,h[recent].ttl)):SCREENACCESS.withApp||a!=TC.LEFT?SCREENACCESS.withApp||a!=TC.RIGHT||(--recent,0>recent&&(recent=h.lenght-1),E.showMessage(h[recent].msg,h[recent].ttl)):(++recent,recent>=h.lenght&&(recent=0),E.showMessage(h[recent].msg,h[recent].ttl)):(g.clear(),SCREENACCESS.release())}))})();
